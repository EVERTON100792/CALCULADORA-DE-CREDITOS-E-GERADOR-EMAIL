<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Logística v18 [ADMIN]</title>
    <style>
        /* --- ESTILOS GERAIS (CSS) --- */
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        :root {
            --bg-color: #1a1a2e;
            --container-color: #1f1f38;
            --primary-color: #4a90e2;
            --primary-hover-color: #357ABD;
            --danger-color: #e24a4a;
            --danger-hover-color: #bd3535;
            --success-color: #28a745;
            --text-color: #e0e0e0;
            --label-color: #a0a0b0;
            --border-color: #40405c;
            --input-bg-color: #2c2c44;
            --preview-bg-color: #25253a;
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background-color: var(--container-color);
            padding: 35px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 850px;
            border-top: 3px solid var(--primary-color);
        }

        h1, h2 {
            color: #ffffff;
            text-align: center;
            margin-top: 0;
            margin-bottom: 30px;
            font-weight: 700;
        }
        h2 { font-size: 1.4em; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px;}
        h3 { color: var(--primary-color); margin-top: 0; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-grid-3-btn { display: grid; grid-template-columns: 1fr 1fr 1fr 120px; gap: 10px; align-items: flex-end;}
        
        .form-group { display: flex; flex-direction: column; }
        .full-width { grid-column: 1 / -1; }

        label { margin-bottom: 8px; font-weight: 500; color: var(--label-color); }
        .radio-group label { margin-bottom: 0; margin-left: 5px; font-weight: 400;}
        .radio-group div { display: flex; align-items: center; }

        input, select, textarea {
            padding: 12px; border: 1px solid var(--border-color); border-radius: 6px;
            font-size: 16px; background-color: var(--input-bg-color); color: var(--text-color);
            transition: border-color 0.3s, box-shadow 0.3s; width: 100%; font-family: 'Roboto', sans-serif;
        }
        textarea { resize: vertical; min-height: 120px; font-family: Consolas, monospace; font-size: 14px; }

        input:focus, select:focus, textarea:focus {
            outline: none; border-color: var(--primary-color); box-shadow: 0 0 8px rgba(74, 144, 226, 0.3);
        }

        .search-input { margin-bottom: 8px; }

        .btn {
            padding: 12px 20px; font-size: 16px; font-weight: 700;
            border-radius: 6px; border: none; cursor: pointer;
            transition: background-color 0.3s, transform 0.1s;
            text-transform: uppercase; width: 100%;
        }
        .btn-small { padding: 8px 12px; font-size: 14px;}
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover-color); }
        .btn-danger { background-color: var(--danger-color); color: white; }
        .btn-danger:hover { background-color: var(--danger-hover-color); }
        .btn-primary.gerador { margin-top: 15px; }
        .btn:active { transform: translateY(1px); }
        
        .mode-switcher { display: flex; gap: 10px; margin-bottom: 25px; }
        .btn-mode {
            flex-grow: 1; padding: 12px; background-color: var(--input-bg-color); color: var(--label-color);
            border: 1px solid var(--border-color); font-weight: 500;
        }
        .btn-mode.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }

        .preview-box {
            background-color: var(--preview-bg-color); border-left: 4px solid var(--primary-color);
            padding: 15px; margin-top: 20px; border-radius: 0 8px 8px 0; font-size: 1.05em;
        }
         .preview-box strong { color: var(--primary-color); font-weight: 700; }
         .preview-box div { margin-top: 5px; }
        
        /* Estilos da aba de Configurações */
        #config-panel { padding-top: 20px; }
        #lista-motoristas-container { 
            max-height: 250px; overflow-y: auto; background-color: var(--input-bg-color);
            border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; margin-top: 20px;
        }
        .motorista-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid var(--border-color);
        }
        .motorista-item:last-child { border-bottom: none; }
        .motorista-item span { font-size: 0.9em; }

        .template-editor { margin-bottom: 30px; }
        .placeholders { font-size: 0.9em; color: var(--label-color); margin-top: 10px; line-height: 1.6; }
        .placeholders code { background: #333; padding: 2px 5px; border-radius: 4px; font-size: 0.95em;}

        .output-area { margin-top: 30px; border-top: 1px solid var(--border-color); padding-top: 25px; }
        .output-group { margin-bottom: 20px; }
        .input-with-btn { display: flex; gap: 10px; }
        .btn-copy {
             padding: 12px 18px; background-color: #6c757d; color: white;
             white-space: nowrap; width: auto; text-transform: none; font-weight: 500;
        }
        .btn-copy:hover { background-color: #5a6268; }
        #bodyOutput { min-height: 200px; resize: vertical; }

    </style>
</head>
<body>

    <div class="container">
        <h1>Gerador de E-mail para Logística</h1>

        <div class="mode-switcher">
            <button id="modeCreditoBtn" class="btn btn-mode active" data-view="forms">Crédito por KM</button>
            <button id="modePortariaBtn" class="btn btn-mode" data-view="forms">Liberação Portaria</button>
            <button id="modeTransbordoBtn" class="btn btn-mode" data-view="forms">Transbordo</button>
            <button id="modeConfigBtn" class="btn btn-mode" data-view="config">&#9881; Configurações</button>
        </div>
        
        <hr style="border-color: var(--border-color); margin: 25px 0;">

        <div id="forms-panel">
            <div id="generalEmailFields">
                <div class="form-group full-width">
                    <label for="emailDestinatario">Destinatário(s) (separar por vírgula):</label>
                    <input type="text" id="emailDestinatario" value="ana@empresa.com" placeholder="email@exemplo.com, outro@exemplo.com">
                </div>
                <div class="form-group full-width">
                    <label for="emailCopia">CC (em cópia - separar por vírgula):</label>
                    <input type="text" id="emailCopia" placeholder="copia@exemplo.com">
                </div>
                 <div class="form-group full-width">
                    <label for="nomeRemetente">Seu Nome (para assinatura):</label>
                    <input type="text" id="nomeRemetente" placeholder="Seu nome completo">
                </div>
            </div>

            <div id="formCredito">
                 <div class="form-group full-width"><label for="motoristaCredito">Selecione o Motorista:</label><select id="motoristaCredito"></select></div>
                <div class="form-grid">
                    <div class="form-group"><label for="kmInformado">KM Informado:</label><input type="number" id="kmInformado" placeholder="Ex: 500"></div>
                    <div class="form-group"><label for="kmPago">KM Pago:</label><input type="number" id="kmPago" placeholder="Ex: 455"></div>
                    <div class="form-group full-width"><label for="motivo">Motivo:</label><select id="motivo"><option value="de estrada de chão">Estrada de Chão</option><option value="de distrito">Distrito</option></select></div>
                    <div class="form-group"><label for="valorKm">Valor por KM (R$):</label><input type="number" id="valorKm" value="2.11" step="0.01"></div>
                    <div class="form-group"><label for="autorizacaoSaida">Nº Saída (Opcional):</label><input type="number" id="autorizacaoSaida" placeholder="Ex: 12345"></div>
                </div>
                <div class="preview-box">Valor do Crédito: <strong id="previewCredito">R$ 0,00</strong></div>
                <button id="gerarCreditoBtn" class="btn btn-primary gerador">Gerar E-mail</button>
            </div>

            <div id="formPortaria" style="display: none;">
                 <div class="form-group full-width"><label for="motoristaPortaria">Selecione o Motorista:</label><select id="motoristaPortaria"></select></div>
                 <div class="form-group full-width"><label for="tipoVeiculo">Tipo de Veículo:</label><select id="tipoVeiculo"><option value="VAN">VAN</option><option value="FIORINO">FIORINO</option><option value="3/4">3/4</option><option value="TOCO">TOCO</option></select></div>
                <button id="gerarPortariaBtn" class="btn btn-primary gerador">Gerar E-mail</button>
            </div>

            <div id="formTransbordo" style="display: none;">
                <div class="form-group full-width radio-group">
                    <label>Tipo de Transbordo:</label>
                    <div><input type="radio" id="tipoProporcional" name="tipoTransbordo" value="proporcional" checked><label for="tipoProporcional">Pagamento Proporcional</label></div>
                    <div><input type="radio" id="tipoIntegral" name="tipoTransbordo" value="integral"><label for="tipoIntegral">Pagamento Integral</label></div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label for="motoristaOriginal">Motorista Original:</label><select id="motoristaOriginal"></select></div>
                    <div class="form-group"><label for="motoristaSubstituto">Motorista Substituto:</label><select id="motoristaSubstituto"></select></div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label for="valorTotalFrete">Valor Total Frete (R$):</label><input type="number" id="valorTotalFrete" placeholder="Ex: 350.00"></div>
                     <div class="form-group"><label for="numeroSaidaTransbordo">Nº Saída:</label><input type="number" id="numeroSaidaTransbordo" placeholder="Ex: 67890"></div>
                </div>
                <div id="camposProporcional" class="form-grid">
                    <div class="form-group"><label for="totalEntregas">Nº Total de Entregas:</label><input type="number" id="totalEntregas" placeholder="Ex: 7"></div>
                    <div class="form-group"><label for="entregasFeitas">Nº Entregas Feitas (Original):</label><input type="number" id="entregasFeitas" placeholder="Ex: 3"></div>
                </div>
                <div class="preview-box">
                    <div>Valor p/ Original: <strong id="previewValorOriginal">R$ 0,00</strong></div>
                    <div>Valor p/ Substituto: <strong id="previewValorSubstituto">R$ 0,00</strong></div>
                </div>
                <button id="gerarTransbordoBtn" class="btn btn-primary gerador">Gerar E-mail</button>
            </div>

             <div id="resultado" class="output-area" style="display: none;">
                <div class="output-group">
                    <label for="subjectOutput">Assunto:</label>
                    <div class="input-with-btn">
                        <input type="text" id="subjectOutput" readonly>
                        <button id="copiarAssuntoBtn" class="btn btn-copy">Copiar</button>
                    </div>
                </div>
                <div class="output-group">
                    <label for="bodyOutput">Corpo do E-mail:</label>
                    <textarea id="bodyOutput" readonly></textarea>
                     <button id="copiarCorpoBtn" class="btn btn-secondary" style="width: 100%; margin-top: 10px;">Copiar Corpo do E-mail</button>
                </div>
            </div>
        </div>

        <div id="config-panel" style="display: none;">
            <h2>Gerenciamento de Motoristas</h2>
            <div class="form-grid-3-btn">
                <div class="form-group"><label for="newMotoristaNome">Nome</label><input type="text" id="newMotoristaNome" placeholder="Nome Completo"></div>
                <div class="form-group"><label for="newMotoristaCodigo">Código</label><input type="text" id="newMotoristaCodigo" placeholder="Ex: 123"></div>
                <div class="form-group"><label for="newMotoristaPlaca">Placa</label><input type="text" id="newMotoristaPlaca" placeholder="ABC1D23"></div>
                <button id="addMotoristaBtn" class="btn btn-primary">Adicionar</button>
            </div>
            <div id="lista-motoristas-container"></div>
            
            <hr style="border-color: var(--border-color); margin: 40px 0;">

            <h2>Templates de E-mail</h2>
            <div class="template-editor">
                <h3>Crédito por KM</h3>
                <div class="form-group"><label for="templateAssuntoCredito">Assunto</label><textarea id="templateAssuntoCredito"></textarea></div>
                <div class="form-group"><label for="templateCorpoCredito">Corpo do E-mail</label><textarea id="templateCorpoCredito"></textarea></div>
                <div class="placeholders">Variáveis: <code>[SAUDACAO]</code> <code>[REMETENTE]</code> <code>[NOME_MOTORISTA]</code> <code>[VALOR_CREDITO]</code> <code>[DIFERENCA_KM]</code> <code>[MOTIVO]</code> <code>[CODIGO_MOTORISTA]</code> <code>[PLACA_MOTORISTA]</code> <code>[NUMERO_SAIDA]</code></div>
            </div>

             <div class="template-editor">
                <h3>Liberação de Portaria</h3>
                <div class="form-group"><label for="templateAssuntoPortaria">Assunto</label><textarea id="templateAssuntoPortaria"></textarea></div>
                <div class="form-group"><label for="templateCorpoPortaria">Corpo do E-mail</label><textarea id="templateCorpoPortaria"></textarea></div>
                <div class="placeholders">Variáveis: <code>[SAUDACAO]</code> <code>[REMETENTE]</code> <code>[NOME_MOTORISTA]</code> <code>[TIPO_VEICULO]</code> <code>[PLACA_MOTORISTA]</code></div>
            </div>

            <div class="template-editor">
                <h3>Transbordo</h3>
                <div class="form-group"><label for="templateAssuntoTransbordo">Assunto</label><textarea id="templateAssuntoTransbordo"></textarea></div>
                <div class="form-group"><label for="templateCorpoTransbordo">Corpo do E-mail</label><textarea id="templateCorpoTransbordo"></textarea></div>
                <div class="placeholders">Use as variáveis abaixo. O sistema escolherá o bloco de texto correto (proporcional ou integral) com base na sua seleção no formulário. <br>
                <strong>Comuns:</strong> <code>[SAUDACAO]</code> <code>[REMETENTE]</code> <code>[NUMERO_SAIDA]</code> <br>
                <strong>Original:</strong> <code>[NOME_ORIGINAL]</code> <code>[CODIGO_ORIGINAL]</code> <code>[PLACA_ORIGINAL]</code> <code>[VALOR_ORIGINAL]</code> <code>[ENTREGAS_FEITAS]</code> <code>[TOTAL_ENTREGAS]</code> <br>
                <strong>Substituto:</strong> <code>[NOME_SUBSTITUTO]</code> <code>[CODIGO_SUBSTITUTO]</code> <code>[PLACA_SUBSTITUTO]</code> <code>[VALOR_SUBSTITUTO]</code> <code>[ENTREGAS_RESTANTES]</code>
                </div>
            </div>

            <button id="saveTemplatesBtn" class="btn btn-primary">Salvar Todos os Templates</button>
        </div>
    </div>

    <script>
    // --- INÍCIO: Estrutura Principal e Lógica de Abas ---
    document.addEventListener('DOMContentLoaded', () => {
        const viewButtons = document.querySelectorAll('.btn-mode');
        const formsPanel = document.getElementById('forms-panel');
        const configPanel = document.getElementById('config-panel');
        const formButtons = document.querySelectorAll('[data-view="forms"]');
        const formDivs = {
            modeCreditoBtn: document.getElementById('formCredito'),
            modePortariaBtn: document.getElementById('formPortaria'),
            modeTransbordoBtn: document.getElementById('formTransbordo'),
        };

        viewButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                viewButtons.forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');

                if (e.target.dataset.view === 'config') {
                    formsPanel.style.display = 'none';
                    configPanel.style.display = 'block';
                } else {
                    formsPanel.style.display = 'block';
                    configPanel.style.display = 'none';
                    
                    formButtons.forEach(fb => fb.classList.remove('active'));
                    e.target.classList.add('active');

                    Object.values(formDivs).forEach(form => form.style.display = 'none');
                    formDivs[e.target.id].style.display = 'block';
                }
            });
        });
        
        formButtons.forEach(btn => {
             btn.addEventListener('click', (e) => {
                if(e.target.dataset.view === 'forms') {
                    formButtons.forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    Object.values(formDivs).forEach(form => form.style.display = 'none');
                    formDivs[e.target.id].style.display = 'block';
                }
            });
        });

        init();
    });

    // --- LÓGICA DE GERENCIAMENTO DE MOTORISTAS ---
    let motoristas = []; 
    let motoristasProcessados = [];

    const motoristasIniciais = [
        { nome: "ABRAAO MESSIAS POLICANTI", codigo: "577", placa: "AGX3I88" }, { nome: "AGENOR DIAS", codigo: "741", placa: "MBF8J91" },
        { nome: "WILSON ALVES SILVEIRA", codigo: "874", placa: "DAH4G00" }
    ];

    function carregarMotoristas() {
        const motoristasSalvos = localStorage.getItem('logistica_motoristas');
        motoristas = motoristasSalvos ? JSON.parse(motoristasSalvos) : motoristasIniciais;
        processarEPopularMotoristas();
        renderizarListaMotoristasAdmin();
    }

    function salvarMotoristas() {
        localStorage.setItem('logistica_motoristas', JSON.stringify(motoristas));
        processarEPopularMotoristas();
        renderizarListaMotoristasAdmin();
    }

    function adicionarMotorista() {
        const nomeInput = document.getElementById('newMotoristaNome');
        const codigoInput = document.getElementById('newMotoristaCodigo');
        const placaInput = document.getElementById('newMotoristaPlaca');

        const nome = nomeInput.value.trim().toUpperCase();
        const codigo = codigoInput.value.trim();
        const placa = placaInput.value.trim().toUpperCase();

        if (!nome || !codigo || !placa) { return alert('Preencha todos os campos do motorista.'); }
        if (motoristas.some(m => m.codigo === codigo)) { return alert('Já existe um motorista com este código.');}

        motoristas.push({ nome, codigo, placa });
        salvarMotoristas();
        nomeInput.value = ''; codigoInput.value = ''; placaInput.value = '';
    }

    function removerMotorista(codigo) {
        if (confirm('Tem certeza que deseja remover este motorista?')) {
            motoristas = motoristas.filter(m => m.codigo !== codigo);
            salvarMotoristas();
        }
    }
    
    function renderizarListaMotoristasAdmin() {
        const container = document.getElementById('lista-motoristas-container');
        container.innerHTML = '';
        const motoristasOrdenados = [...motoristas].sort((a, b) => a.nome.localeCompare(b.nome));

        if (motoristasOrdenados.length === 0) {
            container.innerHTML = '<p style="text-align:center; color: var(--label-color);">Nenhum motorista cadastrado.</p>';
            return;
        }
        
        motoristasOrdenados.forEach(m => {
            const item = document.createElement('div');
            item.className = 'motorista-item';
            item.innerHTML = `
                <div><strong>${m.nome}</strong><br><span>Cód: ${m.codigo} | Placa: ${m.placa}</span></div>
                <button class="btn btn-danger btn-small" data-codigo="${m.codigo}">Remover</button>
            `;
            container.appendChild(item);
        });
    }

    function processarEPopularMotoristas() {
         const nomesVistos = new Set();
         motoristasProcessados = motoristas.filter(m => {
             const nomeTrimmed = m.nome.trim();
             if (nomeTrimmed && !nomesVistos.has(nomeTrimmed)) {
                 nomesVistos.add(nomeTrimmed); return true;
             }
             return false;
         }).sort((a, b) => a.nome.localeCompare(b.nome));

        popularMotoristas(document.getElementById('motoristaCredito'), motoristasProcessados);
        popularMotoristas(document.getElementById('motoristaPortaria'), motoristasProcessados);
        popularMotoristas(document.getElementById('motoristaOriginal'), motoristasProcessados);
        popularMotoristas(document.getElementById('motoristaSubstituto'), motoristasProcessados);
    }
    
    function popularMotoristas(selectElement, lista) {
        const valorAtual = selectElement.value;
        selectElement.innerHTML = '<option value="" disabled selected>-- Escolha um motorista --</option>';
        lista.forEach(m => {
            const option = document.createElement('option');
            option.value = m.nome; option.textContent = m.nome;
            selectElement.appendChild(option);
        });
        selectElement.value = valorAtual;
    }

    // --- LÓGICA DE TEMPLATES DE E-MAIL ---
    const templatesPadrao = {
        assuntoCredito: 'Lançamento de Crédito - Diferença de KM - [NOME_MOTORISTA]',
        corpoCredito: '[SAUDACAO],\n\nPor gentileza, lançar um crédito no valor de [VALOR_CREDITO] para o motorista [NOME_MOTORISTA], referente a diferença de [DIFERENCA_KM] km [MOTIVO].\n\nSeguem os dados para conferência:\n\nMotorista: [NOME_MOTORISTA]\nLCONT00[CODIGO_MOTORISTA]\nPlaca: [PLACA_MOTORISTA]\n[NUMERO_SAIDA]\nQualquer dúvida, estou à disposição.\n\n[REMETENTE]',
        assuntoPortaria: 'Liberação para Abastecimento - [NOME_MOTORISTA]',
        corpoPortaria: '[SAUDACAO],\n\nPor gentileza, liberar o motorista [NOME_MOTORISTA] para fazer o abastecimento do(a) [TIPO_VEICULO], placa [PLACA_MOTORISTA].\n\nObrigado.\n\n[REMETENTE]',
        assuntoTransbordo: 'Lançamento de Rota - Transbordo ([NOME_ORIGINAL] -> [NOME_SUBSTITUTO])',
        corpoTransbordo: `[SAUDACAO],\n\n-- PAGAMENTO PROPORCIONAL --\nPor favor, lançar o valor proporcional referente ao transbordo feito entre os motoristas abaixo ([NUMERO_SAIDA]):\n\nMOTORISTA ORIGINAL:\nNome: [NOME_ORIGINAL]\nLCONT00[CODIGO_ORIGINAL]\nPlaca: [PLACA_ORIGINAL]\nVALOR A RECEBER: [VALOR_ORIGINAL] (referente a [ENTREGAS_FEITAS] de [TOTAL_ENTREGAS] entregas)\n\nMOTORISTA SUBSTITUTO:\nNome: [NOME_SUBSTITUTO]\nLCONT00[CODIGO_SUBSTITUTO]\nPlaca: [PLACA_SUBSTITUTO]\nVALOR A RECEBER: [VALOR_SUBSTITUTO] (referente às [ENTREGAS_RESTANTES] entregas restantes)\n\n-- PAGAMENTO INTEGRAL --\nPor favor, lançar o valor integral do frete para o motorista substituto ([NUMERO_SAIDA]):\n\nMOTORISTA SUBSTITUTO (assumiu a rota completa):\nNome: [NOME_SUBSTITUTO]\nLCONT00[CODIGO_SUBSTITUTO]\nPlaca: [PLACA_SUBSTITUTO]\nVALOR A RECEBER: [VALOR_SUBSTITUTO] (valor integral)\n\nO motorista original, [NOME_ORIGINAL], não receberá valor por esta rota.\n\n-- FIM --\nQualquer dúvida, estou à disposição.\n\n[REMETENTE]`
    };
    const templateIds = ['Credito', 'Portaria', 'Transbordo'];

    function carregarTemplates() {
        templateIds.forEach(id => {
            document.getElementById(`templateAssunto${id}`).value = localStorage.getItem(`template_assunto${id}`) || templatesPadrao[`assunto${id.toLowerCase()}`];
            document.getElementById(`templateCorpo${id}`).value = localStorage.getItem(`template_corpo${id}`) || templatesPadrao[`corpo${id.toLowerCase()}`];
        });
    }

    function salvarTemplates() {
        templateIds.forEach(id => {
            localStorage.setItem(`template_assunto${id}`, document.getElementById(`templateAssunto${id}`).value);
            localStorage.setItem(`template_corpo${id}`, document.getElementById(`templateCorpo${id}`).value);
        });
        alert('Templates salvos com sucesso!');
    }
    
    // --- LÓGICA DE GERAÇÃO DOS E-MAILS ---
    function formatarMoeda(valor) { return valor.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }); }

    function gerarEmailCredito() {
        const nomeMotorista = document.getElementById('motoristaCredito').value;
        if (!nomeMotorista) return alert("Selecione um motorista.");
        
        const kmInformado = parseFloat(document.getElementById('kmInformado').value);
        const kmPago = parseFloat(document.getElementById('kmPago').value);
        if (isNaN(kmInformado) || isNaN(kmPago) || kmInformado <= kmPago) {
            return alert("Verifique os valores de KM. O 'KM Informado' deve ser maior que o 'KM Pago'.");
        }
        
        const motorista = motoristas.find(m => m.nome === nomeMotorista);
        const valorCredito = (kmInformado - kmPago) * parseFloat(document.getElementById('valorKm').value);
        const autorizacao = document.getElementById('autorizacaoSaida').value.trim();

        const placeholders = {
            SAUDACAO: new Date().getHours() < 12 ? "Bom dia" : "Boa tarde",
            REMETENTE: document.getElementById('nomeRemetente').value.trim() || "Att.",
            NOME_MOTORISTA: motorista.nome,
            VALOR_CREDITO: formatarMoeda(valorCredito),
            DIFERENCA_KM: kmInformado - kmPago,
            MOTIVO: document.getElementById('motivo').value,
            CODIGO_MOTORISTA: motorista.codigo,
            PLACA_MOTORISTA: motorista.placa,
            NUMERO_SAIDA: autorizacao ? `Número da Saída: ${autorizacao}` : ''
        };
        
        const { corpo, assunto } = gerarComTemplate('Credito', placeholders);
        exibirResultado(assunto, corpo);
    }

    function gerarEmailPortaria() {
        const nomeMotorista = document.getElementById('motoristaPortaria').value;
        if (!nomeMotorista) return alert("Selecione um motorista.");
        const motorista = motoristas.find(m => m.nome === nomeMotorista);
        
        const placeholders = {
            SAUDACAO: new Date().getHours() < 12 ? "Bom dia" : "Boa tarde",
            REMETENTE: document.getElementById('nomeRemetente').value.trim() || "Att.",
            NOME_MOTORISTA: motorista.nome,
            TIPO_VEICULO: document.getElementById('tipoVeiculo').value,
            PLACA_MOTORISTA: motorista.placa
        };
        const { corpo, assunto } = gerarComTemplate('Portaria', placeholders);
        exibirResultado(assunto, corpo);
    }

    function gerarEmailTransbordo() {
        const nomeOriginal = document.getElementById('motoristaOriginal').value;
        const nomeSubstituto = document.getElementById('motoristaSubstituto').value;
        const valorTotal = parseFloat(document.getElementById('valorTotalFrete').value);
        if (!nomeOriginal || !nomeSubstituto) { return alert("Selecione os dois motoristas."); }
        if (nomeOriginal === nomeSubstituto) { return alert("Os motoristas não podem ser os mesmos."); }
        if (isNaN(valorTotal) || valorTotal <= 0) { return alert("Insira um valor de frete válido."); }

        const motoristaOriginal = motoristas.find(m => m.nome === nomeOriginal);
        const motoristaSubstituto = motoristas.find(m => m.nome === nomeSubstituto);
        const tipo = document.querySelector('input[name="tipoTransbordo"]:checked').value;
        const numeroSaida = document.getElementById('numeroSaidaTransbordo').value.trim();

        let placeholders = {
             SAUDACAO: new Date().getHours() < 12 ? "Bom dia" : "Boa tarde",
             REMETENTE: document.getElementById('nomeRemetente').value.trim() || "Att.",
             NUMERO_SAIDA: numeroSaida ? `(Saída ${numeroSaida})` : '',
             NOME_ORIGINAL: motoristaOriginal.nome,
             CODIGO_ORIGINAL: motoristaOriginal.codigo,
             PLACA_ORIGINAL: motoristaOriginal.placa,
             NOME_SUBSTITUTO: motoristaSubstituto.nome,
             CODIGO_SUBSTITUTO: motoristaSubstituto.codigo,
             PLACA_SUBSTITUTO: motoristaSubstituto.placa
        };

        let corpoTemplate = localStorage.getItem('template_corpoTransbordo') || templatesPadrao.corpoTransbordo;
        if (tipo === 'proporcional') {
            const totalEntregas = parseInt(document.getElementById('totalEntregas').value);
            const entregasFeitas = parseInt(document.getElementById('entregasFeitas').value);
            if (isNaN(totalEntregas) || isNaN(entregasFeitas) || totalEntregas <= 0 || entregasFeitas < 0 || entregasFeitas > totalEntregas) {
                return alert("Verifique os números de entrega.");
            }
            const valorOriginal = (valorTotal / totalEntregas) * entregasFeitas;
            const valorSubstituto = valorTotal - valorOriginal;
            
            Object.assign(placeholders, {
                VALOR_ORIGINAL: formatarMoeda(valorOriginal),
                VALOR_SUBSTITUTO: formatarMoeda(valorSubstituto),
                ENTREGAS_FEITAS: entregasFeitas,
                TOTAL_ENTREGAS: totalEntregas,
                ENTREGAS_RESTANTES: totalEntregas - entregasFeitas
            });
            corpoTemplate = corpoTemplate.split('-- PAGAMENTO INTEGRAL --')[0];
        } else {
             Object.assign(placeholders, { VALOR_SUBSTITUTO: formatarMoeda(valorTotal) });
             corpoTemplate = corpoTemplate.split('-- PAGAMENTO PROPORCIONAL --')[0] + corpoTemplate.split('-- FIM --')[0].split('-- PAGAMENTO INTEGRAL --')[1];
        }
        
        const {corpo, assunto} = gerarComTemplate('Transbordo', placeholders, corpoTemplate);
        exibirResultado(assunto, corpo);
    }
    
    function gerarComTemplate(id, placeholders, corpoOverride = null) {
        let corpo = corpoOverride || document.getElementById(`templateCorpo${id}`).value;
        let assunto = document.getElementById(`templateAssunto${id}`).value;
        for (const key in placeholders) {
            const regex = new RegExp(`\\[${key}\\]`, 'g');
            corpo = corpo.replace(regex, placeholders[key]);
            assunto = assunto.replace(regex, placeholders[key]);
        }
        return { corpo, assunto };
    }

    // --- LÓGICA DE PREVIEW E UTILITÁRIOS ---
    function atualizarPreviewCredito() {
        const kmInfo = parseFloat(document.getElementById('kmInformado').value) || 0;
        const kmPago = parseFloat(document.getElementById('kmPago').value) || 0;
        const valorKm = parseFloat(document.getElementById('valorKm').value) || 0;
        const preview = document.getElementById('previewCredito');
        preview.textContent = (kmInfo > kmPago) ? formatarMoeda((kmInfo - kmPago) * valorKm) : formatarMoeda(0);
    }

    function atualizarPreviewTransbordo() {
        const valorTotal = parseFloat(document.getElementById('valorTotalFrete').value) || 0;
        const tipo = document.querySelector('input[name="tipoTransbordo"]:checked').value;
        const originalSpan = document.getElementById('previewValorOriginal');
        const substitutoSpan = document.getElementById('previewValorSubstituto');

        if (tipo === 'proporcional') {
            const total = parseInt(document.getElementById('totalEntregas').value) || 0;
            const feitas = parseInt(document.getElementById('entregasFeitas').value) || 0;
            if (total > 0 && feitas >= 0 && feitas <= total) {
                const valorOriginal = (valorTotal / total) * feitas;
                originalSpan.textContent = formatarMoeda(valorOriginal);
                substitutoSpan.textContent = formatarMoeda(valorTotal - valorOriginal);
            } else {
                originalSpan.textContent = formatarMoeda(0);
                substitutoSpan.textContent = formatarMoeda(0);
            }
        } else {
            originalSpan.textContent = formatarMoeda(0);
            substitutoSpan.textContent = formatarMoeda(valorTotal);
        }
    }
    
    function exibirResultado(assunto, corpo) {
        document.getElementById('subjectOutput').value = assunto;
        document.getElementById('bodyOutput').value = corpo.replace('-- PAGAMENTO PROPORCIONAL --\n', '').replace('-- FIM --\n', '').trim();
        document.getElementById('resultado').style.display = 'block';
    }

    function copiarTexto(element, button) {
        navigator.clipboard.writeText(element.value).then(() => {
            const originalText = button.textContent;
            button.textContent = 'Copiado!'; button.style.backgroundColor = 'var(--success-color)';
            setTimeout(() => {
                button.textContent = originalText; button.style.backgroundColor = '';
            }, 2000);
        }).catch(err => alert('Erro ao copiar: ', err));
    }
    
    // --- FUNÇÃO DE INICIALIZAÇÃO GERAL ---
    function init() {
        carregarMotoristas();
        carregarTemplates();
        
        // Listeners da Configuração
        document.getElementById('addMotoristaBtn').addEventListener('click', adicionarMotorista);
        document.getElementById('saveTemplatesBtn').addEventListener('click', salvarTemplates);
        document.getElementById('lista-motoristas-container').addEventListener('click', e => {
            if (e.target.classList.contains('btn-danger')) {
                removerMotorista(e.target.dataset.codigo);
            }
        });
        
        // Listeners dos Formulários
        document.getElementById('gerarCreditoBtn').addEventListener('click', gerarEmailCredito);
        document.getElementById('gerarPortariaBtn').addEventListener('click', gerarEmailPortaria);
        document.getElementById('gerarTransbordoBtn').addEventListener('click', gerarEmailTransbordo);

        // Listeners dos Previews
        ['kmInformado', 'kmPago', 'valorKm'].forEach(id => document.getElementById(id).addEventListener('input', atualizarPreviewCredito));
        ['valorTotalFrete', 'totalEntregas', 'entregasFeitas'].forEach(id => document.getElementById(id).addEventListener('input', atualizarPreviewTransbordo));
        document.querySelectorAll('input[name="tipoTransbordo"]').forEach(radio => radio.addEventListener('change', atualizarPreviewTransbordo));

        // Listeners de Copiar
        document.getElementById('copiarAssuntoBtn').addEventListener('click', () => copiarTexto(document.getElementById('subjectOutput'), document.getElementById('copiarAssuntoBtn')));
        document.getElementById('copiarCorpoBtn').addEventListener('click', () => copiarTexto(document.getElementById('bodyOutput'), document.getElementById('copiarCorpoBtn')));
        
        // Carrega dados salvos dos campos
        const fieldsToSave = ['emailDestinatario', 'emailCopia', 'nomeRemetente'];
        fieldsToSave.forEach(id => {
            const el = document.getElementById(id);
            el.value = localStorage.getItem(`logistica_field_${id}`) || el.value;
            el.addEventListener('keyup', () => localStorage.setItem(`logistica_field_${id}`, el.value));
        });
    }

    </script>
</body>
</html>
